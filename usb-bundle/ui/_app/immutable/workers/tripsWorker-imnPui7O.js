(function(){"use strict";function k(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var C={exports:{}},O;function G(){return O||(O=1,(function(e){var n={};function o(r){return Math.floor(Math.abs(r)+.5)*(r>=0?1:-1)}function i(r,t,a){r=o(r*a),t=o(t*a);var l=(r-t)*2;l<0&&(l=-l-1);for(var u="";l>=32;)u+=String.fromCharCode((32|l&31)+63),l/=32;return u+=String.fromCharCode((l|0)+63),u}n.decode=function(r,t){for(var a=0,l=0,u=0,h=[],d=0,c=0,f=null,m,p,y=Math.pow(10,Number.isInteger(t)?t:5);a<r.length;){f=null,d=1,c=0;do f=r.charCodeAt(a++)-63,c+=(f&31)*d,d*=32;while(f>=32);m=c&1?(-c-1)/2:c/2,d=1,c=0;do f=r.charCodeAt(a++)-63,c+=(f&31)*d,d*=32;while(f>=32);p=c&1?(-c-1)/2:c/2,l+=m,u+=p,h.push([l/y,u/y])}return h},n.encode=function(r,t){if(!r.length)return"";for(var a=Math.pow(10,Number.isInteger(t)?t:5),l=i(r[0][0],0,a)+i(r[0][1],0,a),u=1;u<r.length;u++){var h=r[u],d=r[u-1];l+=i(h[0],d[0],a),l+=i(h[1],d[1],a)}return l};function s(r){for(var t=[],a=0;a<r.length;a++){var l=r[a].slice();t.push([l[1],l[0]])}return t}n.fromGeoJSON=function(r,t){if(r&&r.type==="Feature"&&(r=r.geometry),!r||r.type!=="LineString")throw new Error("Input must be a GeoJSON LineString");return n.encode(s(r.coordinates),t)},n.toGeoJSON=function(r,t){var a=n.decode(r,t);return{type:"LineString",coordinates:s(a)}},e.exports&&(e.exports=n)})(C)),C.exports}var P=G(),z=k(P),W=/\{[^{}]+\}/g,g=({allowReserved:e,name:n,value:o})=>{if(o==null)return"";if(typeof o=="object")throw new Error("Deeply-nested arrays/objects arenâ€™t supported. Provide your own `querySerializer()` to handle these.");return`${n}=${e?o:encodeURIComponent(o)}`},B=e=>{switch(e){case"label":return".";case"matrix":return";";case"simple":return",";default:return"&"}},H=e=>{switch(e){case"form":return",";case"pipeDelimited":return"|";case"spaceDelimited":return"%20";default:return","}},J=e=>{switch(e){case"label":return".";case"matrix":return";";case"simple":return",";default:return"&"}},T=({allowReserved:e,explode:n,name:o,style:i,value:s})=>{if(!n){let a=(e?s:s.map(l=>encodeURIComponent(l))).join(H(i));switch(i){case"label":return`.${a}`;case"matrix":return`;${o}=${a}`;case"simple":return a;default:return`${o}=${a}`}}let r=B(i),t=s.map(a=>i==="label"||i==="simple"?e?a:encodeURIComponent(a):g({allowReserved:e,name:o,value:a})).join(r);return i==="label"||i==="matrix"?r+t:t},E=({allowReserved:e,explode:n,name:o,style:i,value:s})=>{if(s instanceof Date)return`${o}=${s.toISOString()}`;if(i!=="deepObject"&&!n){let a=[];Object.entries(s).forEach(([u,h])=>{a=[...a,u,e?h:encodeURIComponent(h)]});let l=a.join(",");switch(i){case"form":return`${o}=${l}`;case"label":return`.${l}`;case"matrix":return`;${o}=${l}`;default:return l}}let r=J(i),t=Object.entries(s).map(([a,l])=>g({allowReserved:e,name:i==="deepObject"?`${o}[${a}]`:a,value:l})).join(r);return i==="label"||i==="matrix"?r+t:t},Y=({path:e,url:n})=>{let o=n,i=n.match(W);if(i)for(let s of i){let r=!1,t=s.substring(1,s.length-1),a="simple";t.endsWith("*")&&(r=!0,t=t.substring(0,t.length-1)),t.startsWith(".")?(t=t.substring(1),a="label"):t.startsWith(";")&&(t=t.substring(1),a="matrix");let l=e[t];if(l==null)continue;if(Array.isArray(l)){o=o.replace(s,T({explode:r,name:t,style:a,value:l}));continue}if(typeof l=="object"){o=o.replace(s,E({explode:r,name:t,style:a,value:l}));continue}if(a==="matrix"){o=o.replace(s,`;${g({name:t,value:l})}`);continue}let u=encodeURIComponent(a==="label"?`.${l}`:l);o=o.replace(s,u)}return o},_=({allowReserved:e,array:n,object:o}={})=>i=>{let s=[];if(i&&typeof i=="object")for(let r in i){let t=i[r];if(t!=null){if(Array.isArray(t)){s=[...s,T({allowReserved:e,explode:!0,name:r,style:"form",value:t,...n})];continue}if(typeof t=="object"){s=[...s,E({allowReserved:e,explode:!0,name:r,style:"deepObject",value:t,...o})];continue}s=[...s,g({allowReserved:e,name:r,value:t})]}}return s.join("&")},K=e=>{if(!e)return;let n=e.split(";")[0].trim();if(n.startsWith("application/json")||n.endsWith("+json"))return"json";if(n==="multipart/form-data")return"formData";if(["application/","audio/","image/","video/"].some(o=>n.startsWith(o)))return"blob";if(n.startsWith("text/"))return"text"},X=({baseUrl:e,path:n,query:o,querySerializer:i,url:s})=>{let r=s.startsWith("/")?s:`/${s}`,t=e+r;n&&(t=Y({path:n,url:t}));let a=o?i(o):"";return a.startsWith("?")&&(a=a.substring(1)),a&&(t+=`?${a}`),t},L=(e,n)=>{let o={...e,...n};return o.baseUrl?.endsWith("/")&&(o.baseUrl=o.baseUrl.substring(0,o.baseUrl.length-1)),o.headers=M(e.headers,n.headers),o},M=(...e)=>{let n=new Headers;for(let o of e){if(!o||typeof o!="object")continue;let i=o instanceof Headers?o.entries():Object.entries(o);for(let[s,r]of i)if(r===null)n.delete(s);else if(Array.isArray(r))for(let t of r)n.append(s,t);else r!==void 0&&n.set(s,typeof r=="object"?JSON.stringify(r):r)}return n},D=class{_fns;constructor(){this._fns=[]}clear(){this._fns=[]}exists(e){return this._fns.indexOf(e)!==-1}eject(e){let n=this._fns.indexOf(e);n!==-1&&(this._fns=[...this._fns.slice(0,n),...this._fns.slice(n+1)])}use(e){this._fns=[...this._fns,e]}},Q=()=>({error:new D,request:new D,response:new D}),V={bodySerializer:e=>JSON.stringify(e)},Z=_({allowReserved:!1,array:{explode:!0,style:"form"},object:{explode:!0,style:"deepObject"}}),ee={"Content-Type":"application/json"},$=(e={})=>({...V,baseUrl:"",fetch:globalThis.fetch,headers:ee,parseAs:"auto",querySerializer:Z,...e}),te=(e={})=>{let n=L($(),e),o=()=>({...n}),i=t=>(n=L(n,t),o()),s=Q(),r=async t=>{let a={...n,...t,headers:M(n.headers,t.headers)};a.body&&a.bodySerializer&&(a.body=a.bodySerializer(a.body)),a.body||a.headers.delete("Content-Type");let l=X({baseUrl:a.baseUrl??"",path:a.path,query:a.query,querySerializer:typeof a.querySerializer=="function"?a.querySerializer:_(a.querySerializer),url:a.url}),u={redirect:"follow",...a},h=new Request(l,u);for(let y of s.request._fns)h=await y(h,a);let d=a.fetch,c=await d(h);for(let y of s.response._fns)c=await y(c,h,a);let f={request:h,response:c};if(c.ok){if(c.status===204||c.headers.get("Content-Length")==="0")return{data:{},...f};if(a.parseAs==="stream")return{data:c.body,...f};let y=(a.parseAs==="auto"?K(c.headers.get("Content-Type")):a.parseAs)??"json",w=await c[y]();return y==="json"&&a.responseTransformer&&(w=await a.responseTransformer(w)),{data:w,...f}}let m=await c.text();try{m=JSON.parse(m)}catch{}let p=m;for(let y of s.error._fns)p=await y(m,c,h,a);if(p=p||{},a.throwOnError)throw p;return{error:p,...f}};return{connect:t=>r({...t,method:"CONNECT"}),delete:t=>r({...t,method:"DELETE"}),get:t=>r({...t,method:"GET"}),getConfig:o,head:t=>r({...t,method:"HEAD"}),interceptors:s,options:t=>r({...t,method:"OPTIONS"}),patch:t=>r({...t,method:"PATCH"}),post:t=>r({...t,method:"POST"}),put:t=>r({...t,method:"PUT"}),request:r,setConfig:i,trace:t=>r({...t,method:"TRACE"})}},N=te($()),re=e=>(e?.client??N).get({...e,url:"/api/v5/map/trips"});function R(e){const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!n)throw`${e} is not a hex color #RRGGBB`;return[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16),255]}const ae=(e,n)=>(e=e/6e4,n?e<=-30?[255,0,255,255]:e<=-6?[138,82,254,255]:e<=3?[69,194,74,255]:e<=5?[255,237,0,255]:e<=10?[255,102,0,255]:e<=15?[255,48,71,255]:[163,0,10,255]:[100,100,100,255]),j=e=>{switch(e.mode){case"WALK":return["walk","hsl(var(--foreground) / 1)","hsl(var(--background) / 1)"];case"BIKE":return["bike","hsl(var(--foreground) / 1)","hsl(var(--background) / 1)"];case"RENTAL":switch(e.rental?.formFactor){case"BICYCLE":return["bike","#075985","white"];case"CARGO_BICYCLE":return["cargo_bike","#075985","white"];case"CAR":return["car","#4c4947","white"];case"MOPED":return["moped","#075985","white"];case"SCOOTER_SEATED":return["seated_scooter","#075985","white"];case"SCOOTER_STANDING":return["scooter","#075985","white"];case"OTHER":default:return["other","#075985","white"]}case"CAR":case"CAR_PARKING":return["car","#4c4947","white"];case"FLEX":case"ODM":return["taxi","#fdb813","white"];case"TRANSIT":case"BUS":return["bus","#ff9800","white"];case"COACH":return["bus","#9ccc65","black"];case"TRAM":return["tram","#ebe717","white"];case"SUBURBAN":return["sbahn","#4caf50","white"];case"SUBWAY":return["ubahn","#3f51b5","white"];case"FERRY":return["ship","#00acc1","white"];case"AIRPLANE":return["plane","#90a4ae","white"];case"HIGHSPEED_RAIL":return["train","#9c27b0","white"];case"LONG_DISTANCE":return["train","#e91e63","white"];case"NIGHT_RAIL":return["train","#1a237e","white"];case"REGIONAL_FAST_RAIL":case"REGIONAL_RAIL":case"RAIL":return["train","#f44336","white"];case"FUNICULAR":return["funicular","#795548","white"];case"CABLE_CAR":return["tram","#795548","white"];case"AERIAL_LIFT":return["aerial_lift","#795548","white"]}return["train","#000000","white"]},U=e=>{const[n,o,i]=j(e);return e.routeColor?[`#${e.routeColor}`,`#${e.routeTextColor}`]:[o,i]},se=e=>e*e*(3-2*e),ne=6371,b=Math.PI/180,oe=180/Math.PI,le=(e,n,o,i)=>{const s=n*2,r=s-2,t=e[s]*b,a=e[s+1]*b,l=e[r]*b,u=e[r+1]*b,h=t-l,d=a-u,c=Math.cos(u),f=Math.cos(a),m=Math.sin(u),p=Math.sin(a),y=Math.cos(h),w=Math.sin(d/2)**2+c*f*Math.sin(h/2)**2,v=2*Math.atan2(Math.sqrt(w),Math.sqrt(1-w))*ne;o[n-1]=v;const A=Math.sin(h)*f,x=c*p-m*f*y;i[n-1]=-(Math.atan2(A,x)*oe+360)%360+90};let q;const I=new Map,S=new Map;let F=[];const ie=async e=>{const{data:n,response:o}=await re({query:e});if(q=o.status,!n)return;I.clear(),S.clear();const i=new Map;for(const s of n){const r=s.trips[0].tripId,t=ce(s);if(!i.has(r))i.set(r,{paths:[t.path],timestamps:[t.timestamps],headings:[t.headings],realtime:t.realtime,mode:t.mode,routeColor:t.routeColor,departureDelay:t.departureDelay,arrivalDelay:t.arrivalDelay});else{const a=i.get(r);a.paths.push(t.path),a.timestamps.push(t.timestamps),a.headings.push(t.headings)}S.set(r,{id:r,displayName:s.trips[0].displayName,tz:s.from.tz,from:s.from.name,to:s.to.name,realtime:s.realTime,arrival:s.arrival,departure:s.departure,scheduledArrival:s.scheduledArrival,scheduledDeparture:s.scheduledDeparture,departureDelay:t.departureDelay,arrivalDelay:t.arrivalDelay})}i.forEach((s,r)=>{let t=0,a=0,l=0;for(let p=0;p<s.paths.length;p++)t+=s.paths[p].length,a+=s.timestamps[p].length,l+=s.headings[p].length;const u=new Float64Array(t),h=new Float64Array(a),d=new Float32Array(l);let c=0,f=0,m=0;for(let p=0;p<s.paths.length;p++)u.set(s.paths[p],c),h.set(s.timestamps[p],f),d.set(s.headings[p],m),c+=s.paths[p].length,f+=s.timestamps[p].length,m+=s.headings[p].length;I.set(r,{realtime:s.realtime,mode:s.mode,routeColor:s.routeColor,path:u,timestamps:h,headings:d,currentIndx:0,departureDelay:s.departureDelay,arrivalDelay:s.arrivalDelay})}),F=Array.from(S.values())},ce=e=>{const n=new Date(e.departure).getTime(),o=new Date(e.arrival).getTime(),i=o-n,s=z.decode(e.polyline),r=s.length,t=new Float64Array(r*2),a=new Float64Array(r),l=new Float32Array(r),u=new Float64Array(r);let h=0;for(let f=0;f<r;f++){const m=s[f],p=m[1],y=m[0];t[f*2]=p,t[f*2+1]=y,f>0&&(le(t,f,u,l),h+=u[f-1])}r>1&&(l[r-1]=l[r-2]);const d=h===0?0:1/h;let c=0;for(let f=0;f<r;f++)a[f]=n+c*d*i,c+=u[f];return{realtime:e.realTime,mode:e.mode,routeColor:e.routeColor,path:t,timestamps:a,headings:l,currentIndx:0,departureDelay:n-new Date(e.scheduledDeparture).getTime(),arrivalDelay:o-new Date(e.scheduledArrival).getTime()}};function ue(e,n){let o=0,i=0,s=0;const r=Date.now();let t;I.forEach(a=>{const l=a.timestamps,u=a.path,h=a.headings,d=l.length;switch(n){case"rt":t=ae(a.departureDelay,a.realtime);break;case"mode":t=R(j(a)[1]);break;case"route":t=R(U(a)[0]);break;case"none":t=R(U(a)[0]);break}e.colors[i]=t[0],e.colors[i+1]=t[1],e.colors[i+2]=t[2];let c=a.currentIndx;for(;c<d-1&&l[c]<r;)c++;a.currentIndx=c;const f=l[d-1];if(c===0)e.positions[o]=u[0],e.positions[o+1]=u[1],e.angles[s]=h[0];else if(c===d-1&&r>=f){const m=2*(d-1);e.positions[o]=u[m],e.positions[o+1]=u[m+1],e.angles[s]=h[d-1]}else if(f>r){const m=l[c-1],p=l[c],y=se((r-m)/(p-m)),w=2*(c-1),v=2*c,A=u[w],x=u[w+1],fe=u[v],he=u[v+1];e.positions[o]=A+(fe-A)*y,e.positions[o+1]=x+(he-x)*y,e.angles[s]=h[c-1]}i+=3,s++,o+=2}),e.length=s}self.onmessage=async e=>{switch(e.data.type){case"init":{const n={array:{explode:!1}};N.setConfig({baseUrl:e.data.baseUrl,querySerializer:n});break}case"fetch":await ie(e.data.query),postMessage({type:"fetch-complete",status:q});break;case"update":{const n=new Float64Array(e.data.positions.buffer),o=new Float32Array(e.data.angles.buffer),i=new Uint8Array(e.data.colors.buffer),s=e.data.index,r={colors:i,positions:n,angles:o,length:0};ue(r,e.data.colorMode),postMessage({angles:r.angles,positions:r.positions,colors:r.colors,length:r.length,metadata:s!==-1?F[s]:null},[r.angles.buffer,r.positions.buffer,r.colors.buffer]);break}}}})();
//# sourceMappingURL=tripsWorker-imnPui7O.js.map
