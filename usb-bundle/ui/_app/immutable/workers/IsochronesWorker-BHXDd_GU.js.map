{"version":3,"file":"IsochronesWorker-BHXDd_GU.js","sources":["../../../src/lib/map/IsochronesWorker.ts"],"sourcesContent":["import type { circle } from '@turf/circle';\nimport type { LngLatBounds } from 'maplibre-gl';\nimport type { Position } from 'geojson';\nimport type { ShapeMessage, UpdateMessage } from '$lib/map/IsochronesShapeWorker';\nimport type { DisplayLevel, Geometry } from '$lib/map/IsochronesShared';\nimport ShapeWorker from '$lib/map/IsochronesShapeWorker.ts?worker';\n\nexport type WorkerMessage = {\n\tmethod: 'update-display-level';\n\tlevel: DisplayLevel;\n\tgeometry?: Geometry | undefined;\n\tindex: number;\n};\ntype CircleType = ReturnType<typeof circle>;\n\nlet canvas: OffscreenCanvas | undefined = undefined;\nlet dataIndex = 0;\nlet shapeWorker: Worker | undefined = undefined;\nlet rects: LngLatBounds[] | undefined = undefined;\nlet circles: CircleType[] | undefined = undefined;\n\nself.onmessage = async function (event) {\n\tconst method = event.data.method;\n\tif (method == 'set-canvas') {\n\t\tcanvas = event.data.canvas;\n\t} else if (method == 'update-data') {\n\t\tconst index: number = event.data.index;\n\t\tconst isochronesData = event.data.data;\n\t\tconst kilometersPerSecond: number = event.data.kilometersPerSecond;\n\t\tconst maxSeconds: number = event.data.maxSeconds;\n\t\tconst circleResolution: number = event.data.circleResolution;\n\t\tdataIndex = index;\n\t\trects = undefined;\n\t\tcircles = undefined;\n\t\tconst worker = createWorker();\n\t\tworker.postMessage({\n\t\t\tmethod: 'set-data',\n\t\t\tindex: dataIndex,\n\t\t\tdata: isochronesData,\n\t\t\tkilometersPerSecond,\n\t\t\tmaxSeconds,\n\t\t\tcircleResolution\n\t\t});\n\t} else if (method == 'set-max-display-level') {\n\t\tif (shapeWorker !== undefined) {\n\t\t\tconst level: DisplayLevel = event.data.displayLevel;\n\t\t\tshapeWorker.postMessage({ method: 'set-max-level', level: level });\n\t\t}\n\t} else if (method == 'render-canvas') {\n\t\tif (!canvas) {\n\t\t\treturn;\n\t\t}\n\t\tconst boundingBox: LngLatBounds = event.data.boundingBox;\n\t\tconst color: string = event.data.color;\n\t\tconst dimensions: [number, number] = event.data.dimensions;\n\t\tconst level: DisplayLevel = event.data.level;\n\t\tcanvas.width = dimensions[0];\n\t\tcanvas.height = dimensions[1];\n\t\tconst ctx = canvas.getContext('2d');\n\t\tif (!ctx) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst transform = getTransformer(boundingBox, dimensions);\n\n\t\tctx.fillStyle = color;\n\t\tctx.clearRect(0, 0, dimensions[0], dimensions[1]);\n\n\t\tif (level == 'OVERLAY_RECTS') {\n\t\t\tdrawRects(ctx, transform);\n\t\t} else if (level == 'OVERLAY_CIRCLES') {\n\t\t\tconst isVisible = getIsVisible(boundingBox);\n\t\t\tdrawCircles(ctx, transform, isVisible);\n\t\t} else {\n\t\t\tconsole.log(`Cannot render level ${level}`);\n\t\t}\n\t}\n};\n\nfunction getTransformer(boundingBox: LngLatBounds, dimensions: [number, number]) {\n\treturn (pos: Position) => {\n\t\tconst x = Math.round(\n\t\t\t((pos[0] - boundingBox._sw.lng) / (boundingBox._ne.lng - boundingBox._sw.lng)) * dimensions[0]\n\t\t);\n\t\tconst y = Math.round(\n\t\t\t((boundingBox._ne.lat - pos[1]) / (boundingBox._ne.lat - boundingBox._sw.lat)) * dimensions[1]\n\t\t);\n\t\treturn [x, y];\n\t};\n}\n\nfunction getIsVisible(boundingBox: LngLatBounds) {\n\treturn (circle: CircleType) => {\n\t\tif (!circle.bbox) {\n\t\t\treturn false;\n\t\t}\n\t\tconst b = circle.bbox; // [minX, minY, maxX, maxY]\n\t\treturn (\n\t\t\tboundingBox._sw.lat <= b[3] &&\n\t\t\tb[1] <= boundingBox._ne.lat &&\n\t\t\tboundingBox._sw.lng <= b[2] &&\n\t\t\tb[0] <= boundingBox._ne.lat\n\t\t);\n\t};\n}\n\nfunction drawRects(ctx: OffscreenCanvasRenderingContext2D, transform: (p: Position) => Position) {\n\tif (rects === undefined) {\n\t\treturn;\n\t}\n\trects.forEach((rect: LngLatBounds) => {\n\t\tctx.save(); // Store canvas state\n\n\t\tconst min = transform([rect._sw.lng, rect._sw.lat]);\n\t\tconst max = transform([rect._ne.lng, rect._ne.lat]);\n\t\tconst diffX = max[0] - min[0];\n\t\tconst diffY = max[1] - min[1];\n\t\tctx.fillRect(min[0], min[1], diffX + 1, diffY + 1);\n\t\t// Restore previous state on top\n\t\tctx.restore();\n\t});\n}\n\nfunction drawCircles(\n\tctx: OffscreenCanvasRenderingContext2D,\n\ttransform: (_: Position) => Position,\n\tisVisible: (_: CircleType) => boolean\n) {\n\tif (circles === undefined) {\n\t\treturn;\n\t}\n\tcircles.filter(isVisible).forEach((circle: CircleType) => {\n\t\tctx.save(); // Store canvas state\n\n\t\tconst b = circle.bbox!; // Existence checked in filter()\n\t\tconst min = transform([b[0], b[1]]);\n\t\tconst max = transform([b[2], b[3]]);\n\t\tconst diffX = max[0] - min[0];\n\t\tconst diffY = max[1] - min[1];\n\n\t\tif (diffX < 2 && diffY < 2) {\n\t\t\t// Draw small rect\n\t\t\tctx.fillRect(min[0], min[1], diffX + 1, diffY + 1);\n\t\t} else {\n\t\t\t// Clip circle\n\t\t\tctx.beginPath();\n\t\t\tconst coords = circle.geometry.coordinates[0];\n\t\t\tconst start = transform(coords[0]);\n\t\t\tctx.moveTo(start[0], start[1]);\n\t\t\tfor (let i = 0; i < coords.length; ++i) {\n\t\t\t\tconst pos = transform(coords[i]);\n\t\t\t\tctx.lineTo(pos[0], pos[1]);\n\t\t\t}\n\t\t\tctx.clip();\n\n\t\t\t// Fill bounding box, clipped to circle\n\t\t\tctx.fillRect(min[0], min[1], diffX + 1, diffY + 1);\n\t\t}\n\n\t\t// Restore previous state on top\n\t\tctx.restore();\n\t});\n}\n\nfunction createWorker() {\n\tshapeWorker?.terminate();\n\n\tshapeWorker = new ShapeWorker();\n\n\tshapeWorker.onmessage = (event: { data: ShapeMessage }) => {\n\t\tconst method = event.data.method;\n\t\tswitch (method) {\n\t\t\tcase 'update-shape':\n\t\t\t\t{\n\t\t\t\t\tconst index = event.data.index;\n\t\t\t\t\tif (index < dataIndex) {\n\t\t\t\t\t\tconsole.log(`Got stale index from shape worker (Got ${index}, expected ${dataIndex})`);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst msg: UpdateMessage = event.data;\n\t\t\t\t\tswitch (msg.level) {\n\t\t\t\t\t\tcase 'OVERLAY_RECTS':\n\t\t\t\t\t\t\trects = msg.data as maplibregl.LngLatBounds[];\n\t\t\t\t\t\t\tself.postMessage({\n\t\t\t\t\t\t\t\tmethod: 'update-display-level',\n\t\t\t\t\t\t\t\tindex: dataIndex,\n\t\t\t\t\t\t\t\tlevel: msg.level\n\t\t\t\t\t\t\t} as WorkerMessage);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'OVERLAY_CIRCLES':\n\t\t\t\t\t\t\tcircles = msg.data;\n\t\t\t\t\t\t\tself.postMessage({\n\t\t\t\t\t\t\t\tmethod: 'update-display-level',\n\t\t\t\t\t\t\t\tindex: dataIndex,\n\t\t\t\t\t\t\t\tlevel: msg.level\n\t\t\t\t\t\t\t} as WorkerMessage);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'GEOMETRY_CIRCLES':\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tconst geometry = msg.data;\n\t\t\t\t\t\t\t\tself.postMessage({\n\t\t\t\t\t\t\t\t\tmethod: 'update-display-level',\n\t\t\t\t\t\t\t\t\tindex: dataIndex,\n\t\t\t\t\t\t\t\t\tlevel: msg.level,\n\t\t\t\t\t\t\t\t\tgeometry: geometry\n\t\t\t\t\t\t\t\t} as WorkerMessage);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tconsole.log(`Unknown message '${msg}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tconsole.log(`Unknown method '${method}'`);\n\t\t}\n\t};\n\treturn shapeWorker;\n}\n"],"names":["canvas","dataIndex","shapeWorker","rects","circles","event","method","index","isochronesData","kilometersPerSecond","maxSeconds","circleResolution","createWorker","level","boundingBox","color","dimensions","ctx","transform","getTransformer","drawRects","isVisible","getIsVisible","drawCircles","pos","x","y","circle","b","rect","min","max","diffX","diffY","coords","start","i","ShapeWorker","msg","geometry"],"mappings":"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"}